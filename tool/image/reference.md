
### systemd code

#### environment variables

https://github.com/systemd/systemd/blob/master/docs/ENVIRONMENT.md

#### Kernel command line parameters

https://www.freedesktop.org/software/systemd/man/kernel-command-line.html

#### The initrd Interface of systemd

https://github.com/systemd/systemd/blob/master/docs/INITRD_INTERFACE.md

#### Storage Daemons for the Root File System

https://systemd.io/ROOT_STORAGE_DAEMONS/

#### "Running with unpopulated /etc"

https://github.com/systemd/systemd/blob/52d247154b0190cddf0d2a2d43e981a74026d320/src/core/main.c#L1863

```c
    /* Let's check whether we are in first boot, i.e. whether /etc is still unpopulated. We use
     * /etc/machine-id as flag file, for this: if it exists we assume /etc is populated, if it
     * doesn't it's unpopulated. This allows container managers and installers to provision a
     * couple of files already. If the container manager wants to provision the machine ID itself
     * it should pass $container_uuid to PID 1. */
```

#### bool in_initrd(void) / SYSTEMD_IN_INITRD

https://github.com/systemd/systemd/blob/5e467d74ad0c87f1f5e1a1e58bdce7b1971dd7a3/src/basic/util.c#L80

```c
     /* We make two checks here:
      *
      * 1. the flag file /etc/initrd-release must exist
      * 2. the root file system must be a memory file system
      *
      * The second check is extra paranoia, since misdetecting an
      * initrd can have bad consequences due the initrd
      * emptying when transititioning to the main systemd.
      */

      r = getenv_bool_secure("SYSTEMD_IN_INITRD");
```

* `$SYSTEMD_IN_INITRD` â€” takes a boolean.  
  If set, overrides initrd detection. 
  This is useful for debugging and testing initrd-only programs in the main system. 

#### sample unit file produced by systemd-cryptsetup-generator

/usr/lib/systemd/system-generators/systemd-cryptsetup-generator


```
# Automatically generated by systemd-cryptsetup-generator

[Unit]
Description=Cryptography Setup for %I
Documentation=man:crypttab(5) man:systemd-cryptsetup-generator(8) man:systemd-cryptsetup@.service(8)
SourcePath=/etc/crypttab
DefaultDependencies=no
Conflicts=umount.target
IgnoreOnIsolate=true
After=cryptsetup-pre.target
Before=cryptsetup.target
BindsTo=dev-disk-by\x2duuid-470f3a4a\x2d342c\x2d4a64\x2d9015\x2df2449708f45d.device
After=dev-disk-by\x2duuid-470f3a4a\x2d342c\x2d4a64\x2d9015\x2df2449708f45d.device
Before=umount.target

[Service]
Type=oneshot
RemainAfterExit=yes
TimeoutSec=0
KeyringMode=shared
OOMScoreAdjust=500
ExecStart=/usr/lib/systemd/systemd-cryptsetup attach 'root' '/dev/disk/by-uuid/00000000-feed-face-0000-added0facade' 'none' 'luks'
ExecStop=/usr/lib/systemd/systemd-cryptsetup detach 'root'

```
